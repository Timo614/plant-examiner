<!DOCTYPE html>
<html lang="en">
<head>
    <script src="js-external/marked.min.js"></script>
    <script src="js-external/purify.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2ecc71">
    <title>Plant Examiner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .language-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .language-selector select {
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 25px;
            border: none;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            min-width: 200px;
        }

        .camera-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .camera-button {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .camera-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5);
        }

        .camera-button:active {
            transform: translateY(0);
        }

        .camera-button svg {
            width: 24px;
            height: 24px;
        }

        input[type="file"] {
            display: none;
        }

        .preview-section {
            margin-top: 20px;
            display: none;
        }

        .preview-image {
            max-width: 256px;
            max-height: 256px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            margin-bottom: 15px;
        }

        .analyzing {
            padding: 15px;
            background: #f0f0f0;
            border-radius: 10px;
            margin-top: 10px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .result {
            padding: 15px;
            background: #e8f8f5;
            border-left: 4px solid #2ecc71;
            border-radius: 5px;
            margin-top: 10px;
            text-align: left;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .error {
            background: #ffeaa7;
            border-left-color: #fdcb6e;
        }

        .history-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .history-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: 600;
        }

        .history-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:hover {
            background: #f8f9fa;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .history-content {
            flex: 1;
            min-width: 0;
        }

        .history-date {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .history-text {
            font-size: 14px;
            color: #2c3e50;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .empty-history {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        .export-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 20px;
            max-width: 500px;
            margin: 50px auto;
        }

        .modal-close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #95a5a6;
        }

        .modal-close:hover {
            color: #2c3e50;
        }

        .modal-image {
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
            display: block;
            border-radius: 10px;
        }

        .modal-result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåø <span data-i18n="appTitle">Plant Examiner</span></h1>
            <p data-i18n="appSubtitle">AI-powered plant disease detection</p>
        </div>

        <div class="language-selector">
            <select id="languageSelect">
                <option value="English">English</option>
                <option value="Chinese">‰∏≠Êñá</option>
                <option value="Hindi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                <option value="Spanish">Espa√±ol</option>
                <option value="Arabic">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                <option value="French">Fran√ßais</option>
                <option value="Bengali">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
                <option value="Portuguese">Portugu√™s</option>
                <option value="Russian">–†—É—Å—Å–∫–∏–π</option>
                <option value="Indonesian">Bahasa Indonesia</option>
                <option value="Urdu">ÿßÿ±ÿØŸà</option>
                <option value="German">Deutsch</option>
                <option value="Japanese">Êó•Êú¨Ë™û</option>
                <option value="Nigerian Pidgin">Nigerian Pidgin</option>
                <option value="Marathi">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
                <option value="Vietnamese">Ti·∫øng Vi·ªát</option>
                <option value="Telugu">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
                <option value="Hausa">Hausa</option>
                <option value="Turkish">T√ºrk√ße</option>
                <option value="Swahili">Kiswahili</option>
                <option value="Tagalog">Tagalog</option>
                <option value="Tamil">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
                <option value="Korean">ÌïúÍµ≠Ïñ¥</option>
                <option value="Thai">‡πÑ‡∏ó‡∏¢</option>
                <option value="Javanese">Basa Jawa</option>
                <option value="Italian">Italiano</option>
                <option value="Hebrew">◊¢◊ë◊®◊ô◊™</option>
            </select>
        </div>

        <div class="camera-section">
            <input type="file" id="fileInput" accept="image/*" capture="environment">
            <button class="camera-button" onclick="document.getElementById('fileInput').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="5" width="18" height="14" rx="2"/>
                    <circle cx="12" cy="12" r="3"/>
                    <circle cx="7" cy="8" r="1"/>
                </svg>
                <span data-i18n="takePhoto">Take Photo</span>
            </button>
            
            <div class="preview-section" id="previewSection">
                <img id="previewImage" class="preview-image" alt="Preview">
                <div id="analyzing" class="analyzing" style="display:none;">
                    <span data-i18n="analyzing">Analyzing plant...</span>
                </div>
                <div id="result" class="result" style="display:none;"></div>
            </div>
        </div>

        <div class="history-section">
            <h2 class="history-title" data-i18n="history">History</h2>
            <div id="historyList" class="empty-history">
                <span data-i18n="noHistory">No analysis history yet</span>
            </div>
            <button class="export-button" onclick="exportHistory()" data-i18n="export">Export History</button>
            <button class="export-button" onclick="clearHistory()" data-i18n="clearHistory">Clear History</button>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDetailModal()">&times;</span>
            <img id="modalImage" class="modal-image" alt="Plant">
            <div id="modalDate" class="history-date"></div>
            <div id="modalResult" class="modal-result"></div>
        </div>
    </div>

    <script>
        // i18n translations
        const translations = {
            'English': {
                appTitle: 'Plant Examiner',
                appSubtitle: 'AI-powered plant disease detection',
                takePhoto: 'Take Photo',
                analyzing: 'Analyzing plant...',
                history: 'History',
                noHistory: 'No analysis history yet',
                export: 'Export History',
                analysisError: 'Analysis failed',
                clearHistory: 'Clear History'
            },
            'Chinese': {
                appTitle: 'Ê§çÁâ©Ê£ÄÊü•Âô®',
                appSubtitle: 'AIÈ©±Âä®ÁöÑÊ§çÁâ©ÁóÖÂÆ≥Ê£ÄÊµã',
                takePhoto: 'ÊãçÁÖß',
                analyzing: 'ÂàÜÊûêÊ§çÁâ©‰∏≠...',
                history: 'ÂéÜÂè≤ËÆ∞ÂΩï',
                noHistory: 'ÊöÇÊó†ÂàÜÊûêÂéÜÂè≤',
                export: 'ÂØºÂá∫ÂéÜÂè≤',
                analysisError: 'ÂàÜÊûêÂ§±Ë¥•',
                clearHistory: 'Ê∏ÖÈô§ÂéÜÂè≤ËÆ∞ÂΩï'
            },
            'Hindi': {
                appTitle: '‡§™‡§æ‡§¶‡§™ ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§ï',
                appSubtitle: '‡§è‡§Ü‡§à-‡§∏‡§Ç‡§ö‡§æ‡§≤‡§ø‡§§ ‡§™‡§æ‡§¶‡§™ ‡§∞‡•ã‡§ó ‡§™‡§π‡§ö‡§æ‡§®',
                takePhoto: '‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§ñ‡•Ä‡§Ç‡§ö‡•ã',
                analyzing: '‡§™‡•å‡§ß‡•á ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...',
                history: '‡§á‡§§‡§ø‡§π‡§æ‡§∏',
                noHistory: '‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à',
                export: '‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç',
                analysisError: '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§µ‡§ø‡§´‡§≤',
                clearHistory: '‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç'
            },
            'Spanish': {
                appTitle: 'Examinador de Plantas',
                appSubtitle: 'Detecci√≥n de enfermedades con IA',
                takePhoto: 'Tomar Foto',
                analyzing: 'Analizando planta...',
                history: 'Historial',
                noHistory: 'Sin historial de an√°lisis',
                export: 'Exportar Historial',
                analysisError: 'Error en an√°lisis',
                clearHistory: 'Borrar historial'
            },
            'Arabic': {
                appTitle: 'ŸÅÿßÿ≠ÿµ ÿßŸÑŸÜÿ®ÿßÿ™ÿßÿ™',
                appSubtitle: 'ÿßŸÑŸÉÿ¥ŸÅ ÿπŸÜ ÿ£ŸÖÿ±ÿßÿ∂ ÿßŸÑŸÜÿ®ÿßÿ™ÿßÿ™ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä',
                takePhoto: 'ÿßŸÑÿ™ŸÇÿ∑ ÿµŸàÿ±Ÿá',
                analyzing: 'ÿ¨ÿßÿ±Ÿç ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜÿ®ÿßÿ™...',
                history: 'ÿ≥ÿ¨ŸÑ',
                noHistory: 'ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥ÿ¨ŸÑ ÿ™ÿ≠ŸÑŸäŸÑ ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ',
                export: 'ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ≥ÿ¨ŸÑ',
                analysisError: 'ŸÅÿ¥ŸÑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ',
                clearHistory: 'ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ'
            },
            'French': {
                appTitle: 'Examinateur de Plantes',
                appSubtitle: 'D√©tection de maladies par IA',
                takePhoto: 'Prendre Photo',
                analyzing: 'Analyse en cours...',
                history: 'Historique',
                noHistory: 'Aucun historique',
                export: 'Exporter Historique',
                analysisError: '√âchec d\'analyse',
                clearHistory: 'Effacer l\'historique'
            },
            'Bengali': {
                appTitle: '‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü ‡¶è‡¶ï‡ßç‡¶∏‡¶æ‡¶Æ‡¶ø‡¶®‡¶æ‡¶∞',
                appSubtitle: '‡¶è‡¶Ü‡¶á-‡¶ö‡¶æ‡¶≤‡¶ø‡¶§ ‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶ ‡¶∞‡ßã‡¶ó ‡¶∏‡¶®‡¶æ‡¶ï‡ßç‡¶§‡¶ï‡¶∞‡¶£',
                takePhoto: '‡¶õ‡¶¨‡¶ø ‡¶§‡ßÅ‡¶≤‡ßÅ‡¶®',
                analyzing: '‡¶â‡¶¶‡ßç‡¶≠‡¶ø‡¶¶ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...',
                history: '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏',
                noHistory: '‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶®‡ßá‡¶á',
                export: '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶è‡¶ï‡ßç‡¶∏‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®',
                analysisError: '‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
                clearHistory: '‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶∏‡¶æ‡¶´ ‡¶ï‡¶∞‡ßÅ‡¶®'
            },
            'Portuguese': {
                appTitle: 'Examinador de Plantas',
                appSubtitle: 'Dete√ß√£o de doen√ßas de plantas com IA',
                takePhoto: 'Tirar Foto',
                analyzing: 'Analisando a planta...',
                history: 'Hist√≥rico',
                noHistory: 'Nenhum hist√≥rico de an√°lise ainda',
                export: 'Exportar Hist√≥rico',
                analysisError: 'A an√°lise falhou',
                clearHistory: 'Limpar Hist√≥rico'
            },
            'Russian': {
                appTitle: '–≠–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–∞—Å—Ç–µ–Ω–∏—è–º',
                appSubtitle: '–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –±–æ–ª–µ–∑–Ω–µ–π —Ä–∞—Å—Ç–µ–Ω–∏–π —Å –ø–æ–º–æ—â—å—é –ò–ò',
                takePhoto: '–°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ',
                analyzing: '–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ç–µ–Ω–∏—è...',
                history: '–ò—Å—Ç–æ—Ä–∏—è',
                noHistory: '–ü–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∞–Ω–∞–ª–∏–∑–æ–≤',
                export: '–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é',
                analysisError: '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞',
                clearHistory: '–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é'
            },
            'Indonesian': {
                appTitle: 'Pemeriksa Tanaman',
                appSubtitle: 'Deteksi penyakit tanaman bertenaga AI',
                takePhoto: 'Ambil Foto',
                analyzing: 'Menganalisis tanaman...',
                history: 'Riwayat',
                noHistory: 'Belum ada riwayat analisis',
                export: 'Ekspor Riwayat',
                analysisError: 'Analisis gagal',
                clearHistory: 'Hapus Riwayat'
            },
            'Urdu': {
                appTitle: 'ŸæŸÑÿßŸÜŸπ ÿß€å⁄Øÿ≤ÿßŸÖ€åŸÜÿ±',
                appSubtitle: 'ÿß€í ÿ¢ÿ¶€å ÿ≥€í ⁄ÜŸÑŸÜ€í ŸàÿßŸÑ€å ŸæŸàÿØŸà⁄∫ ⁄©€å ÿ®€åŸÖÿßÿ±€å ⁄©ÿß Ÿæÿ™€Å ŸÑ⁄ØÿßŸÜÿß',
                takePhoto: 'ÿ™ÿµŸà€åÿ± ŸÑ€å⁄∫',
                analyzing: 'ŸæŸàÿØ€í ⁄©ÿß ÿ™ÿ¨ÿ≤€å€Å ⁄©€åÿß ÿ¨ÿß ÿ±€Åÿß €Å€í...',
                history: 'ÿ™ÿßÿ±€åÿÆ',
                noHistory: 'ÿßÿ®⁄æ€å ÿ™⁄© ÿ™ÿ¨ÿ≤€å€Å ⁄©€å ⁄©Ÿàÿ¶€å ÿ™ÿßÿ±€åÿÆ ŸÜ€Å€å⁄∫ €Å€í€î',
                export: 'ÿ™ÿßÿ±€åÿÆ ÿ®ÿ±ÿ¢ŸÖÿØ ⁄©ÿ±€å⁄∫',
                analysisError: 'ÿ™ÿ¨ÿ≤€å€Å ŸÜÿß⁄©ÿßŸÖ',
                clearHistory: 'ÿ™ÿßÿ±€åÿÆ ÿµÿßŸÅ ⁄©ÿ±€å⁄∫'
            },
            'German': {
                appTitle: 'Pflanzenpr√ºfer',
                appSubtitle: 'KI-gest√ºtzte Pflanzenerkrankungserkennung',
                takePhoto: 'Foto machen',
                analyzing: 'Pflanze wird analysiert...',
                history: 'Verlauf',
                noHistory: 'Noch kein Analyseprotokoll',
                export: 'Verlauf exportieren',
                analysisError: 'Analyse fehlgeschlagen',
                clearHistory: 'Verlauf l√∂schen'
            },
            'Japanese': {
                appTitle: 'Ê§çÁâ©Ë®∫Êñ≠',
                appSubtitle: 'AI„Å´„Çà„ÇãÊ§çÁâ©„ÅÆÁóÖÊ∞óÊ§úÂá∫',
                takePhoto: 'ÂÜôÁúü„ÇíÊíÆ„Çã',
                analyzing: 'Ê§çÁâ©„ÇíÂàÜÊûê‰∏≠...',
                history: 'Â±•Ê≠¥',
                noHistory: 'ÂàÜÊûêÂ±•Ê≠¥„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì',
                export: 'Â±•Ê≠¥„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà',
                analysisError: 'ÂàÜÊûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',
                clearHistory: 'Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢'
            },
            'Nigerian Pidgin': {
                appTitle: 'Plant Examiner',
                appSubtitle: 'AI-powered plant disease detection',
                takePhoto: 'Take Photo',
                analyzing: 'Dey analyze plant...',
                history: 'History',
                noHistory: 'No analysis history yet',
                export: 'Export History',
                analysisError: 'Analysis fail',
                clearHistory: 'Clear History'
            },
            'Marathi': {
                appTitle: '‡§µ‡§®‡§∏‡•ç‡§™‡§§‡•Ä ‡§§‡§™‡§æ‡§∏‡§®‡•Ä‡§∏',
                appSubtitle: '‡§è‡§Ü‡§Ø-‡§ö‡§æ‡§≤‡§ø‡§§ ‡§µ‡§®‡§∏‡•ç‡§™‡§§‡•Ä ‡§∞‡•ã‡§ó ‡§∂‡•ã‡§ß',
                takePhoto: '‡§´‡•ã‡§ü‡•ã ‡§ï‡§æ‡§¢‡§æ',
                analyzing: '‡§µ‡§®‡§∏‡•ç‡§™‡§§‡•Ä‡§ö‡•á ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...',
                history: '‡§á‡§§‡§ø‡§π‡§æ‡§∏',
                noHistory: '‡§Ö‡§¶‡•ç‡§Ø‡§æ‡§™ ‡§ï‡•ã‡§£‡§§‡§æ‡§π‡•Ä ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§®‡§æ‡§π‡•Ä',
                export: '‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡§æ',
                analysisError: '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§Ö‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä',
                clearHistory: '‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§∏‡§æ‡§´ ‡§ï‡§∞‡§æ'
            },
            'Vietnamese': {
                appTitle: 'Gi√°m ƒë·ªãnhTh·ª±c v·∫≠t',
                appSubtitle: 'Ph√°t hi·ªán b·ªánh c√¢y tr·ªìng b·∫±ng AI',
                takePhoto: 'Ch·ª•p ·∫£nh',
                analyzing: 'ƒêang ph√¢n t√≠ch c√¢y...',
                history: 'L·ªãch s·ª≠',
                noHistory: 'Ch∆∞a c√≥ l·ªãch s·ª≠ ph√¢n t√≠ch',
                export: 'Xu·∫•t l·ªãch s·ª≠',
                analysisError: 'Ph√¢n t√≠ch th·∫•t b·∫°i',
                clearHistory: 'X√≥a l·ªãch s·ª≠'
            },
            'Telugu': {
                appTitle: '‡∞Æ‡±ä‡∞ï‡±ç‡∞ï‡∞≤ ‡∞™‡∞∞‡±Ä‡§ï‡•ç‡§∑‡§ï',
                appSubtitle: 'AI- ‡∞∂‡∞ï‡±ç‡∞§‡∞ø‡∞§‡±ã ‡∞™‡∞®‡∞ø‡∞ö‡±á‡∞∏‡±á ‡∞Æ‡±ä‡∞ï‡±ç‡∞ï‡∞≤ ‡∞µ‡±ç‡∞Ø‡∞æ‡∞ß‡∞ø ‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞£',
                takePhoto: '‡∞´‡±ã‡∞ü‡±ã ‡∞§‡±Ä‡∞Ø‡∞Ç‡∞°‡∞ø',
                analyzing: '‡∞Æ‡±ä‡∞ï‡±ç‡∞ï‡∞®‡±Å ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞ø‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...',
                history: '‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞',
                noHistory: '‡∞á‡∞Ç‡∞ï‡∞æ ‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞£ ‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞ ‡∞≤‡±á‡∞¶‡±Å',
                export: '‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞‡∞®‡±Å ‡∞é‡∞ó‡±Å‡∞Æ‡∞§‡∞ø ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø',
                analysisError: '‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞£ ‡∞µ‡∞ø‡∞´‡∞≤‡∞Æ‡±à‡∞Ç‡∞¶‡∞ø',
                clearHistory: '‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞‡∞®‡±Å ‡∞ï‡±ç‡∞≤‡∞ø‡∞Ø‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø'
            },
            'Hausa': {
                appTitle: 'Mai Binciken Shuka',
                appSubtitle: 'Gano cutar shuka mai amfani da AI',
                takePhoto: 'Dauki Hoto',
                analyzing: 'Ana nazarin shuka...',
                history: 'Tarihi',
                noHistory: 'Babu tarihin bincike tukuna',
                export: 'Tarihin Fitarwa',
                analysisError: 'Bincike ya gaza',
                clearHistory: 'Share Tarihi'
            },
            'Turkish': {
                appTitle: 'Bitki ƒ∞nceleyici',
                appSubtitle: 'AI destekli bitki hastalƒ±ƒüƒ± tespiti',
                takePhoto: 'Fotoƒüraf √áek',
                analyzing: 'Bitki analiz ediliyor...',
                history: 'Ge√ßmi≈ü',
                noHistory: 'Hen√ºz analiz ge√ßmi≈üi yok',
                export: 'Ge√ßmi≈üi Dƒ±≈üa Aktar',
                analysisError: 'Analiz ba≈üarƒ±sƒ±z',
                clearHistory: 'Ge√ßmi≈üi Temizle'
            },
            'Swahili': {
                appTitle: 'Mkaguzi wa Mimea',
                appSubtitle: 'Utambuzi wa magonjwa ya mimea unaoendeshwa na AI',
                takePhoto: 'Piga Picha',
                analyzing: 'Inachambua mmea...',
                history: 'Historia',
                noHistory: 'Bado hakuna historia ya uchambuzi',
                export: 'Historia ya Hamisha',
                analysisError: 'Uchambuzi umeshindwa',
                clearHistory: 'Futa Historia'
            },
            'Tagalog': {
                appTitle: 'Tagasuri ng Halaman',
                appSubtitle: 'Pagtukoy ng sakit sa halaman na pinapagana ng AI',
                takePhoto: 'Kuhanan ng Larawan',
                analyzing: 'Sinusuri ang halaman...',
                history: 'Kasaysayan',
                noHistory: 'Wala pang kasaysayan ng pagsusuri',
                export: 'I-export ang Kasaysayan',
                analysisError: 'Nabigo ang pagsusuri',
                clearHistory: 'I-clear ang Kasaysayan'
            },
            'Tamil': {
                appTitle: '‡Æ§‡Ææ‡Æµ‡Æ∞ ‡ÆÜ‡ÆØ‡Øç‡Æµ‡Ææ‡Æ≥‡Æ∞‡Øç',
                appSubtitle: 'AI-‡Æá‡ÆØ‡Æô‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç ‡Æ§‡Ææ‡Æµ‡Æ∞ ‡Æ®‡Øã‡ÆØ‡Øç ‡Æï‡Æ£‡Øç‡Æü‡Æ±‡Æø‡Æ§‡Æ≤‡Øç',
                takePhoto: '‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æü‡ÆÆ‡Øç ‡Æé‡Æü‡ØÅ',
                analyzing: '‡Æ§‡Ææ‡Æµ‡Æ∞‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...',
                history: '‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ',
                noHistory: '‡Æá‡Æ©‡Øç‡Æ©‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà',
                export: '‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡Øç‡Æ±‡Øà ‡Æè‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Æ§‡Æø ‡Æö‡ØÜ‡ÆØ‡Øç',
                analysisError: '‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æ§‡Øá‡Ææ‡Æ≤‡Øç‡Æµ‡Æø‡ÆØ‡Æü‡Øà‡Æ®‡Øç‡Æ§‡Æ§‡ØÅ',
                clearHistory: '‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡Øç‡Æ±‡Øà ‡ÆÖ‡Æ¥‡Æø'
            },
            'Korean': {
                appTitle: 'ÏãùÎ¨º Í≤ÄÏÇ¨Í∏∞',
                appSubtitle: 'AI Í∏∞Î∞ò ÏãùÎ¨º ÏßàÎ≥ë ÌÉêÏßÄ',
                takePhoto: 'ÏÇ¨ÏßÑ Ï¥¨ÏòÅ',
                analyzing: 'ÏãùÎ¨º Î∂ÑÏÑù Ï§ë...',
                history: 'Í∏∞Î°ù',
                noHistory: 'Î∂ÑÏÑù Í∏∞Î°ùÏù¥ ÏïÑÏßÅ ÏóÜÏäµÎãàÎã§',
                export: 'Í∏∞Î°ù ÎÇ¥Î≥¥ÎÇ¥Í∏∞',
                analysisError: 'Î∂ÑÏÑù Ïã§Ìå®',
                clearHistory: 'Í∏∞Î°ù ÏÇ≠Ï†ú'
            },
            'Thai': {
                appTitle: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡∏ä',
                appSubtitle: '‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡πÇ‡∏£‡∏Ñ‡∏û‡∏∑‡∏ä‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ AI',
                takePhoto: '‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û',
                analyzing: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏û‡∏∑‡∏ä...',
                history: '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥',
                noHistory: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå',
                export: '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥',
                analysisError: '‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß',
                clearHistory: '‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'
            },
            'Javanese': {
                appTitle: 'Pemeriksa Tanduran',
                appSubtitle: 'Deteksi penyakit tanduran kanthi tenaga AI',
                takePhoto: 'Njupuk Foto',
                analyzing: 'Nganalisa tanduran...',
                history: 'Riwayat',
                noHistory: 'Durung ana riwayat analisis',
                export: 'Ekspor Riwayat',
                analysisError: 'Analisis gagal',
                clearHistory: 'Busak Riwayat'
            },
            'Italian': {
                appTitle: 'Esaminatore di Piante',
                appSubtitle: 'Rilevamento di malattie delle piante basato su IA',
                takePhoto: 'Scatta Foto',
                analyzing: 'Analisi della pianta in corso...',
                history: 'Cronologia',
                noHistory: 'Nessuna cronologia di analisi ancora',
                export: 'Esporta Cronologia',
                analysisError: 'Analisi fallita',
                clearHistory: 'Cancella Cronologia'
            },
            'Hebrew': {
                appTitle: '◊ë◊ï◊ó◊ü ◊¶◊û◊ó◊ô◊ù',
                appSubtitle: '◊ñ◊ô◊î◊ï◊ô ◊û◊ó◊ú◊ï◊™ ◊¶◊û◊ó◊ô◊ù ◊û◊ë◊ï◊°◊° ◊ë◊ô◊†◊î ◊û◊ú◊ê◊õ◊ï◊™◊ô◊™',
                takePhoto: '◊¶◊ú◊ù ◊™◊û◊ï◊†◊î',
                analyzing: '◊û◊†◊™◊ó ◊¶◊û◊ó...',
                history: '◊î◊ô◊°◊ò◊ï◊®◊ô◊î',
                noHistory: '◊ê◊ô◊ü ◊¢◊ì◊ô◊ô◊ü ◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊†◊ô◊™◊ï◊ó◊ô◊ù',
                export: '◊ô◊ô◊¶◊ï◊ê ◊î◊ô◊°◊ò◊ï◊®◊ô◊î',
                analysisError: '◊î◊†◊ô◊™◊ï◊ó ◊†◊õ◊©◊ú',
                clearHistory: '◊†◊ß◊î ◊î◊ô◊°◊ò◊ï◊®◊ô◊î'
            }
        };

        // Global variables
        const apiBase = 'http://192.168.1.189:8000'; 
        let currentLanguage = localStorage.getItem('language') || 'English';
        let history = JSON.parse(localStorage.getItem('history') || '[]');

        // Initialize app
        window.addEventListener('DOMContentLoaded', () => {
            // Set language
            document.getElementById('languageSelect').value = currentLanguage;
            updateUI();
            
            // Check API health
            checkAPIHealth();

            // Load history
            displayHistory();

            // Setup file input handler
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // Setup language change handler
            document.getElementById('languageSelect').addEventListener('change', (e) => {
                currentLanguage = e.target.value;
                localStorage.setItem('language', currentLanguage);
                updateUI();
            });
        });

        function updateUI() {
            const trans = translations[currentLanguage] || translations['English'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (trans[key]) {
                    el.textContent = trans[key];
                }
            });
        }

        async function checkAPIHealth() {
            try {
                const response = await fetch(`${apiBase}/health`);
                if (!response.ok) {
                    console.error('API health check failed - API may not be running');
                }
            } catch (error) {
                console.error('API is not accessible:', error);
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                resizeAndAnalyzeImage(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function resizeAndAnalyzeImage(dataUrl) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                let width = img.width;
                let height = img.height;
                const maxSize = 256;

                if (width > height) {
                    if (width > maxSize) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.8);

                document.getElementById('previewImage').src = resizedDataUrl;
                document.getElementById('previewSection').style.display = 'block';
                document.getElementById('result').style.display = 'none';

                analyzeImage(resizedDataUrl);
            };
            img.src = dataUrl;
        }

        async function analyzeImage(dataUrl) {
            const trans = translations[currentLanguage] || translations['English'];
            document.getElementById('analyzing').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            try {
                const base64Data = dataUrl.split(',')[1];
                const response = await fetch(`${apiBase}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image_base64: base64Data,
                        language: currentLanguage
                    })
                });

                const data = await response.json();
                document.getElementById('analyzing').style.display = 'none';

                if (data.success) {
                    const resultDiv = document.getElementById('result');
                    const html = DOMPurify.sanitize(marked.parse(data.result));
                    resultDiv.innerHTML = html;
                    resultDiv.className = 'result';
                    resultDiv.style.display = 'block';

                    const historyItem = {
                        id: Date.now(),
                        image: dataUrl,
                        result: data.result,
                        language: currentLanguage,
                        date: new Date().toISOString()
                    };
                    history.unshift(historyItem);
                    if (history.length > 50) history.pop();
                    localStorage.setItem('history', JSON.stringify(history));
                    displayHistory();
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }
            } catch (error) {
                console.error('Analysis failed:', error);
                document.getElementById('analyzing').style.display = 'none';
                const resultDiv = document.getElementById('result');
                resultDiv.textContent = `${trans.analysisError}: ${error.message}`;
                resultDiv.className = 'result error';
                resultDiv.style.display = 'block';
            }
        }

        function displayHistory() {
            const historyList = document.getElementById('historyList');

            if (history.length === 0) {
                const trans = translations[currentLanguage] || translations['English'];
                historyList.className = 'empty-history';
                historyList.innerHTML = `<span>${trans.noHistory}</span>`;
                return;
            }

            historyList.className = '';
            historyList.innerHTML = history.map(item => {
                const date = new Date(item.date);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                const firstLine = item.result.split('\n')[0].replace(/[*#]/g, '').trim();

                return `
                    <div class="history-item" onclick="showDetail(${item.id})">
                        <img src="${item.image}" class="history-image" alt="Plant">
                        <div class="history-content">
                            <div class="history-date">${dateStr}</div>
                            <div class="history-text">${firstLine}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showDetail(id) {
            const item = history.find(h => h.id === id);
            if (!item) return;

            document.getElementById('modalImage').src = item.image;
            document.getElementById('modalDate').textContent = new Date(item.date).toLocaleString();
            document.getElementById('modalResult').textContent = item.result;
            document.getElementById('detailModal').style.display = 'block';
        }

        function closeDetailModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        function clearHistory() {
            // 1) wipe the in-memory array
            history = [];
            // 2) remove from localStorage
            localStorage.removeItem('history');
            // 3) re-render the UI
            displayHistory();
        }

        function exportHistory() {
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                history: history
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plant-examiner-history-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
